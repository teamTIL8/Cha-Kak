<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <meta charset="UTF-8" />
    <style>
      .info-title {
        position: relative;
        display: inline-block;
        z-index: 9999; /* í•­ìƒ ìœ„ì— ë³´ì´ê²Œ */
        background: #50627f;
        color: #fff;
        text-align: center;
        padding: 8px 14px;
        font-size: 13px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        animation: fadeInUp 0.4s ease-out;

        white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
        max-width: 220px; /* í•„ìš” ì‹œ ë„ˆë¹„ ì œí•œ */
        overflow: hidden; /* ë„˜ì¹˜ëŠ” í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
        text-overflow: ellipsis; /* ë„˜ì¹  ë•Œ ... ì²˜ë¦¬ */
      }

      /* ê¼¬ë¦¬ */
      .info-title::after {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 8px 8px 0 8px;
        border-style: solid;
        border-color: #50627f transparent transparent transparent;
      }

      /* ë¶€ë“œëŸ¬ìš´ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body>
    <h1>ğŸ“Š ê´€ë¦¬ì í†µê³„ ëŒ€ì‹œë³´ë“œ</h1>

    <!-- ì¤‘ë³µ ì œë³´ ì°¨ëŸ‰ Top 10 -->
    <section>
      <h2>ğŸš— ì¤‘ë³µ ì œë³´ ì°¨ëŸ‰ Top 10</h2>
      <table border="1">
        <tr>
          <th>ìˆœìœ„</th>
          <th>ì°¨ëŸ‰ ë²ˆí˜¸</th>
          <th>ì œë³´ íšŸìˆ˜</th>
        </tr>
        <tr th:each="v, stat : ${topVehicles}">
          <td th:text="${stat.index + 1}">1</td>
          <td th:text="${v.vehicleNumber}">12ê°€1234</td>
          <td th:text="${v.count}">3</td>
        </tr>
      </table>
    </section>

    <!-- ì œë³´ ìœ í˜• ë¶„í¬ -->
    <section>
      <h2>ğŸ“Š ì œë³´ ìœ í˜•ë³„ ë¶„í¬</h2>
      <table border="1">
        <tr>
          <th>ìœ í˜•</th>
          <th>ì œë³´ ìˆ˜</th>
        </tr>
        <tr th:each="t : ${typeStats}">
          <td th:text="${t.violationType}">ìì „ê±°ë„ë¡œ</td>
          <td th:text="${t.count}">5</td>
        </tr>
      </table>
    </section>

    <!-- ë°˜ë³µ ì œë³´ ìœ„ì¹˜ Top 10 -->
    <section>
      <h2>ğŸ˜ï¸ ë°˜ë³µ ì œë³´ ì§€ì—­ Top 10</h2>
      <table border="1">
        <tr>
          <th>ìˆœìœ„</th>
          <th>ì£¼ì†Œ</th>
          <th>ì œë³´ ìˆ˜</th>
        </tr>
        <tr th:each="a, stat : ${locationStats}">
          <td th:text="${stat.index + 1}">1</td>
          <td th:text="${a.location}">ì„œìš¸ì‹œ ê°•ë‚¨êµ¬</td>
          <td th:text="${a.count}">7</td>
        </tr>
      </table>
    </section>

    <!-- ì§€ì—­ë³„ ì œë³´ íˆíŠ¸ë§µ -->
    <section>
      <h2>ğŸ—ºï¸ ì§€ì—­ë³„ ì œë³´ í´ëŸ¬í„°ë§ ì§€ë„</h2>
      <!-- html -->
      <div id="map" style="width: 800px; height: 500px"></div>
    </section>

    <section>
      <h2>ğŸš¦ ì œë³´ ìœ í˜•ë³„ í•„í„°</h2>
      <label for="violationType">ì‹ ê³  ìœ í˜• ì„ íƒ:</label>
      <select id="violationType" name="violationType">
        <option value="" selected>ì„ íƒ</option>
        <option
          th:each="type : ${violationTypeList}"
          th:value="${type.name}"
          th:text="${type.label}"
        ></option>
      </select>
      <table border="1" id="reportTable">
        <thead>
          <tr>
            <th>ì‹ ê³  ë²ˆí˜¸</th>
            <th>ì œëª©</th>
            <th>ìœ„ë°˜ ìœ í˜•</th>
            <th>ìœ„ë°˜ ì§€ì—­</th>
            <th>ìœ„ë°˜ ì¼ì</th>
          </tr>
        </thead>
        <tbody>
          <!-- JSë¡œ ë™ì  ë Œë”ë§ -->
        </tbody>
      </table>
    </section>

   <!-- ì¹´ì¹´ì˜¤ ì§€ë„ sdk -->
    <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=978b749ade2fb05402a450e0de2bc2a6&autoload=true&libraries=services,clusterer"></script>

    <script>
		window.onload = () => {
		   const container = document.getElementById('map'); // ì§€ë„ë¥¼ í‘œì‹œí•  div
		   const options = {
		     center: new kakao.maps.LatLng(37.5665, 126.9780), //ì§€ë„ì˜ ì¤‘ì‹¬ ì¢Œí‘œ
		     level: 7 //ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
		   };
		   const map = new kakao.maps.Map(container, options);

		//ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„±
		   const clusterer = new kakao.maps.MarkerClusterer({
		     map: map, // ë§ˆì»¤ë“¤ì„ í´ëŸ¬ìŠ¤í„°ë¡œ ê´€ë¦¬í•˜ê³  í‘œì‹œí•  ì§€ë„ ê°ì²´ 
		     averageCenter: true, // í´ëŸ¬ìŠ¤í„°ì— í¬í•¨ëœ ë§ˆì»¤ë“¤ì˜ í‰ê·  ìœ„ì¹˜ë¥¼ í´ëŸ¬ìŠ¤í„° ë§ˆì»¤ ìœ„ì¹˜ë¡œ ì„¤ì •
		     minLevel: 6 // í´ëŸ¬ìŠ¤í„° í•  ìµœì†Œ ì§€ë„ ë ˆë²¨ 
		   });
		   
		   fetch('/admin/statistics/map',{
			method: "GET",
			credentials: "include"
		   })
		     .then(res => res.json())
		     .then(data => {
		       const markers = [];

			   let currentInfoWindow = null; // í˜„ì¬ ì—´ë ¤ ìˆëŠ” ì¸í¬ìœˆë„ìš° ì¶”ì 
			   
		       data.forEach(p => {
		         const marker = new kakao.maps.Marker({
		           position: new kakao.maps.LatLng(p.latitude, p.longitude)
		         });

		         const address = p.address || 'ì£¼ì†Œ ì—†ìŒ';

		         const infowindow = new kakao.maps.InfoWindow({
		           content: `<div class="info-title">${address}</div>`, // ì¸í¬ ìœˆë„ìš° ë‚´ì— ë“¤ì–´ê°ˆ ì»¨í…ì¸ 
		           removable: false 
		         });
				 
				 // í´ë¦­ì‹œ ë§í’ì„  ì—´ë¦¼ (ë‹«ì§€ëŠ” X)
				 kakao.maps.event.addListener(marker, 'click', function () {
				   infowindow.open(map, marker);
				   currentInfoWindow = infowindow;
				   
				   //ê¼¬ë¦¬/ë°°ê²½ ì œê±°
				   setTimeout(() => {
			         const infoTitles = document.querySelectorAll('.info-title');
			         infoTitles.forEach(e => {
			           const parent = e.parentElement;
			           if (parent?.previousSibling) {
			             parent.previousSibling.style.display = 'none'; // ê¼¬ë¦¬ ì œê±°
			           }
			           if (parent?.parentElement) {
			             parent.parentElement.style.border = 'none';
			             parent.parentElement.style.background = 'unset';
			             parent.parentElement.style.boxShadow = 'none';
			           }
			         });
			       }, 10); // ì§§ê²Œ ì§€ì—°í•´ì„œ DOM ë¶™ì€ í›„ ì‹¤í–‰
				 });
				 
		         markers.push(marker);
		       });

			   // ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ì— ë“±ë¡
		       clusterer.addMarkers(markers);
			   
		     })
		     .catch(err => console.error("í´ëŸ¬ìŠ¤í„°ë§ ë¡œë”© ì‹¤íŒ¨:", err));
			};

      document.addEventListener("DOMContentLoaded", function () {
        const select = document.getElementById("violationType");

        select.addEventListener("change", function () {
          const type = select.value;
          if (!type) return;

          fetch(`/admin/statistics/by-type?violationType=${type}`)
            .then((res) => {
              if (!res.ok) throw new Error("ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜");
              return res.json();
            })
            .then((data) => {
              const tableBody = document.querySelector("#reportTable tbody");
              tableBody.innerHTML = "";

              if (data.length === 0) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 7;
                cell.innerText = "í•´ë‹¹ ìœ í˜•ì˜ ì œë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
                row.appendChild(cell);
                tableBody.appendChild(row);
                return;
              }

              data.forEach((report, index) => {
                const row = document.createElement("tr");

                const region = report.address ?? "-";
                const date = new Date(report.reportTime).toLocaleString();

                row.innerHTML = `
								<td>${report.reportId}</td>
								<td>${report.title}</td>
								<td>${report.violationType}</td>
								<td>${region}</td>
								<td>${date}</td>
							`;

                tableBody.appendChild(row);
              });
            })
            .catch((err) => {
              console.error("ìš”ì²­ ì‹¤íŒ¨:", err);
              alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        });
      });
    </script>

    <p><a th:href="@{/admin/users}">â–¶ íšŒì› ê´€ë¦¬</a></p>
  </body>
</html>
