<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>마이페이지</title>
	<link rel="stylesheet" href="/css/style.css">
</head>

<body>
	<div class="container">
		<h1>마이페이지</h1>
		<div id="userInfo">
			<p>로딩 중...</p>
		</div>
		<div>
			<a href="/edit-profile" class="button">정보 수정</a>
			<a href="/home" class="button">홈으로 돌아가기</a>
			<button id="withdrawButton" class="button" style="background-color: #dc3545;">회원 탈퇴</button>
		</div>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', async function () {
			const userInfoDiv = document.getElementById('userInfo');

			try {
				const response = await fetch('/api/auth/me'); // 현재 사용자 정보 API 호출
				if (response.ok) {
					const userData = await response.json();
					userInfoDiv.innerHTML = `
                        <p><strong>사용자 ID:</strong> ${userData.userId}</p>
                        <p><strong>이메일:</strong> ${userData.email}</p>
                        <p><strong>이름:</strong> ${userData.name}</p>
                        <p><strong>역할:</strong> ${userData.role}</p>
                    `;
				} else if (response.status === 401) {
					userInfoDiv.innerHTML = '<p class="error-message">로그인이 필요합니다.</p>';
					setTimeout(() => {window.location.href = '/login';}, 1500);
				} else {
					userInfoDiv.innerHTML = '<p class="error-message">사용자 정보를 가져오는 데 실패했습니다.</p>';
				}
			} catch (error) {
				console.error('Error fetching user info:', error);
				userInfoDiv.innerHTML = '<p class="error-message">네트워크 오류가 발생했습니다.</p>';
			}
			// 회원 탈퇴 버튼 클릭 이벤트
			const withdrawButton = document.getElementById('withdrawButton');
			withdrawButton.addEventListener('click', async function () {
				if (confirm('정말로 회원 탈퇴를 하시겠습니까? 탈퇴 시 모든 정보가 삭제되며 복구할 수 없습니다.')) {
					try {
						const response = await fetch('/api/auth/withdraw', {
							method: 'DELETE',
							headers: {
								'Content-Type': 'application/json'
							}
						});

						if (response.ok) {
							alert('회원 탈퇴가 성공적으로 처리되었습니다. 로그인 페이지로 이동합니다.');
							window.location.href = '/login'; // 로그인 페이지로 리다이렉트
						} else if (response.status === 401) {
							alert('인증되지 않았거나 세션이 만료되었습니다. 로그인 페이지로 이동합니다.');
							window.location.href = '/login';
						} else {
							const errorData = await response.json();
							alert('회원 탈퇴 중 오류가 발생했습니다: ' + (errorData.message || '알 수 없는 오류'));
						}
					} catch (error) {
						console.error('회원 탈퇴 중 네트워크 오류:', error);
						alert('네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.');
					}
				}
			});
		});
	</script>
</body>

</html>