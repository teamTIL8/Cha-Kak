<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>íšŒì›ì •ë³´ ìˆ˜ì • - Chakak</title>
	<link rel="stylesheet" href="/css/style.css">
</head>

<body>
	<!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
	<nav class="navbar">
		<div class="container">
			<a class="navbar-brand" href="/">ğŸ  Chakak</a>
			<div class="navbar-nav" th:if="${user != null}">
				<span class="navbar-text">ì•ˆë…•í•˜ì„¸ìš”, <strong th:text="${user.name}"></strong>ë‹˜!</span>
				<a class="nav-link" href="/">í™ˆ</a>
				<a class="nav-link" th:href="@{/mypage}">ë§ˆì´í˜ì´ì§€</a>
				<form style="display: inline;" th:action="@{/logout}" method="post">
					<button type="submit" class="btn secondary">ë¡œê·¸ì•„ì›ƒ</button>
				</form>
			</div>
		</div>
	</nav>

	<!-- ë©”ì¸ ì»¨í…ì¸  -->
	<div class="container">
		<div class="card">
			<div class="card-header">
				<h1>âœï¸ íšŒì›ì •ë³´ ìˆ˜ì •</h1>
			</div>
			<div class="card-body">
				<!-- ì„±ê³µ ë©”ì‹œì§€ -->
				<div th:if="${message}" class="success-message">
					<span th:text="${message}"></span>
				</div>

				<form th:action="@{/edit}" th:object="${updateDto}" method="post" id="profileForm"
					class="form-container">
					<!-- ê¸°ë³¸ ì •ë³´ ì„¹ì…˜ -->
					<h3>ğŸ“‹ ê¸°ë³¸ ì •ë³´</h3>

					<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
						<div class="form-group">
							<label for="email">ì´ë©”ì¼</label>
							<input type="email"
								th:class="${#fields.hasErrors('email')} ? 'form-control error' : 'form-control'"
								id="email" th:field="*{email}" placeholder="ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
							<div class="invalid-feedback" th:if="${#fields.hasErrors('email')}">
								<span th:errors="*{email}"></span>
							</div>
						</div>

						<div class="form-group">
							<label for="name">ì´ë¦„</label>
							<input type="text"
								th:class="${#fields.hasErrors('name')} ? 'form-control error' : 'form-control'"
								id="name" th:field="*{name}" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
							<div class="invalid-feedback" th:if="${#fields.hasErrors('name')}">
								<span th:errors="*{name}"></span>
							</div>
						</div>
					</div>

					<!-- ë³´ì•ˆ ì¸ì¦ ì„¹ì…˜ -->
					<h3>ğŸ”’ ë³´ì•ˆ ì¸ì¦</h3>

					<div class="form-group">
						<label for="currentPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ <span style="color: #e74c3c;">*</span></label>
						<input type="password"
							th:class="${#fields.hasErrors('currentPassword')} ? 'form-control error' : 'form-control'"
							id="currentPassword" th:field="*{currentPassword}" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
						<div class="invalid-feedback" th:if="${#fields.hasErrors('currentPassword')}">
							<span th:errors="*{currentPassword}"></span>
						</div>
						<div class="form-text">
							â„¹ï¸ ì •ë³´ ìˆ˜ì •ì„ ìœ„í•´ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.
						</div>
					</div>

					<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì„¹ì…˜ -->
					<div class="checkbox-container">
						<input type="checkbox" id="changePasswordCheck" name="changePassword" value="true">
						<label for="changePasswordCheck">
							<strong>ğŸ”‘ ë¹„ë°€ë²ˆí˜¸ë„ í•¨ê»˜ ë³€ê²½í•˜ê¸°</strong>
						</label>
					</div>

					<div id="passwordSection" class="password-section" style="display: none;">
						<h3>ğŸ” ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</h3>

						<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
							<div class="form-group">
								<label for="password">ìƒˆ ë¹„ë°€ë²ˆí˜¸ <span style="color: #e74c3c;">*</span></label>
								<input type="password"
									th:class="${#fields.hasErrors('password')} ? 'form-control error' : 'form-control'"
									id="password" th:field="*{password}" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
								<div class="invalid-feedback" th:if="${#fields.hasErrors('password')}">
									<span th:errors="*{password}"></span>
								</div>
							</div>

							<div class="form-group">
								<label for="passwordConfirm">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span style="color: #e74c3c;">*</span></label>
								<input type="password" class="form-control" id="passwordConfirm"
									placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
								<div class="invalid-feedback" id="passwordConfirmError" style="display: none;">
									ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
								</div>
							</div>
						</div>

						<div class="warning-message">
							âš ï¸ ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¤ë¥´ê²Œ ì„¤ì •í•´ì£¼ì„¸ìš”.
						</div>
					</div>

					<div class="button-group">
						<a th:href="@{/mypage}" class="button secondary">ì·¨ì†Œ</a>
						<button type="submit" class="button success" id="submitBtn">âœ… ìˆ˜ì •í•˜ê¸°</button>
					</div>
				</form>
			</div>
		</div>

		<!-- í˜„ì¬ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ -->
		<div class="card" th:if="${user != null}">
			<div class="card-header">
				<h3>â„¹ï¸ í˜„ì¬ ê³„ì • ì •ë³´</h3>
			</div>
			<div class="card-body">
				<div class="user-info">
					<p><strong>ì‚¬ìš©ì ID:</strong> <span th:text="${user.userId}"></span></p>
					<p><strong>í˜„ì¬ ì´ë©”ì¼:</strong> <span th:text="${user.email}"></span></p>
					<p><strong>í˜„ì¬ ì´ë¦„:</strong> <span th:text="${user.name}"></span></p>
					<p><strong>ê¶Œí•œ:</strong> <span th:text="${user.role}"></span></p>
					<p><strong>ê°€ì…ì¼:</strong> <span
							th:text="${#temporals.format(user.createdAt, 'yyyyë…„ MMì›” ddì¼ HH:mm')}"></span></p>
					<p><strong>ìµœì¢… ìˆ˜ì •ì¼:</strong> <span
							th:text="${user.updatedAt != null ? #temporals.format(user.updatedAt, 'yyyyë…„ MMì›” ddì¼ HH:mm') : 'ì—†ìŒ'}"></span>
					</p>
				</div>
			</div>
		</div>
	</div>

	<script>
		// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
		document.getElementById('changePasswordCheck').addEventListener('change', function () {
			const passwordSection = document.getElementById('passwordSection');
			const passwordField = document.getElementById('password');
			const passwordConfirmField = document.getElementById('passwordConfirm');

			if (this.checked) {
				passwordSection.style.display = 'block';
			} else {
				passwordSection.style.display = 'none';
				passwordField.value = '';
				passwordConfirmField.value = '';
				passwordField.classList.remove('error', 'success');
				passwordConfirmField.classList.remove('error', 'success');
			}
		});

		// ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ê²€ì¦
		function validatePasswordConfirm() {
			const password = document.getElementById('password').value;
			const passwordConfirm = document.getElementById('passwordConfirm').value;
			const passwordConfirmField = document.getElementById('passwordConfirm');
			const errorDiv = document.getElementById('passwordConfirmError');

			if (password && passwordConfirm) {
				if (password === passwordConfirm) {
					passwordConfirmField.classList.remove('error');
					passwordConfirmField.classList.add('success');
					errorDiv.style.display = 'none';
					return true;
				} else {
					passwordConfirmField.classList.remove('success');
					passwordConfirmField.classList.add('error');
					errorDiv.style.display = 'block';
					return false;
				}
			}
			return true;
		}

		// ì‹¤ì‹œê°„ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ê²€ì¦
		document.getElementById('password').addEventListener('input', validatePasswordConfirm);
		document.getElementById('passwordConfirm').addEventListener('input', validatePasswordConfirm);

		// í¼ ì œì¶œ ì‹œ ì¶”ê°€ ê²€ì¦
		document.getElementById('profileForm').addEventListener('submit', function (e) {
			const changePasswordCheck = document.getElementById('changePasswordCheck');
			const currentPassword = document.getElementById('currentPassword').value.trim();

			if (!currentPassword) {
				alert('ë³´ì•ˆì„ ìœ„í•´ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
				e.preventDefault();
				return;
			}

			if (changePasswordCheck.checked) {
				const newPassword = document.getElementById('password').value.trim();

				if (!newPassword) {
					alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
					e.preventDefault();
					return;
				}

				if (!validatePasswordConfirm()) {
					e.preventDefault();
					alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
					return;
				}

				if (currentPassword === newPassword) {
					e.preventDefault();
					alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¬ë¼ì•¼ í•©ë‹ˆë‹¤.');
					return;
				}
			}
		});

		// í˜ì´ì§€ ë¡œë“œ ì‹œ ì—ëŸ¬ê°€ ìˆìœ¼ë©´ ë¹„ë°€ë²ˆí˜¸ ì„¹ì…˜ í‘œì‹œ
		document.addEventListener('DOMContentLoaded', function () {
			const hasPasswordErrors = document.querySelector('.invalid-feedback [th\\:errors*="password"]');

			if (hasPasswordErrors) {
				document.getElementById('changePasswordCheck').checked = true;
				document.getElementById('passwordSection').style.display = 'block';
			}
		});
	</script>
</body>

</html>