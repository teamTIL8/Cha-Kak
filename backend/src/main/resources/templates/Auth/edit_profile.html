<!DOCTYPE html>
<html lang="ko">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>회원 정보 수정</title>
	<link rel="stylesheet" href="/css/style.css">
</head>

<body>
	<div class="container">
		<h1>회원 정보 수정</h1>
		<form id="editProfileForm">
			<div class="form-group">
				<label for="userId">사용자 ID (수정 불가):</label>
				<input type="text" id="userId" name="userId" readonly disabled>
			</div>
			<div class="form-group">
				<label for="email">이메일 (수정 불가):</label>
				<input type="email" id="email" name="email" readonly disabled>
			</div>
			<div class="form-group">
				<label for="name">이름:</label>
				<input type="text" id="name" name="name" required>
			</div>
			<div class="form-group">
				<label for="password">새 비밀번호 (변경 시에만 입력):</label>
				<input type="password" id="password" name="password" placeholder="비밀번호 변경 시 입력">
			</div>
			<div class="form-group">
				<label for="confirmPassword">새 비밀번호 확인:</label>
				<input type="password" id="confirmPassword" name="confirmPassword" placeholder="비밀번호 변경 시 입력">
			</div>
			<button type="submit" class="button">정보 저장</button>
		</form>
		<p id="message" class="error-message"></p>
		<p><a href="/mypage" class="button">마이페이지로 돌아가기</a></p>
	</div>

	<script>
		document.addEventListener('DOMContentLoaded', async function () {
			const userIdInput = document.getElementById('userId');
			const emailInput = document.getElementById('email');
			const nameInput = document.getElementById('name');
			const passwordInput = document.getElementById('password');
			const confirmPasswordInput = document.getElementById('confirmPassword');
			const messageElement = document.getElementById('message');
			const editProfileForm = document.getElementById('editProfileForm');

			// 1. 현재 사용자 정보 불러와서 폼에 채우기
			try {
				const response = await fetch('/api/auth/me');
				if (response.ok) {
					const userData = await response.json();
					userIdInput.value = userData.userId;
					emailInput.value = userData.email;
					nameInput.value = userData.name;
				} else if (response.status === 401) {
					messageElement.className = 'error-message';
					messageElement.textContent = '로그인이 필요합니다. 로그인 페이지로 이동합니다.';
					setTimeout(() => {window.location.href = '/login';}, 1500);
				} else {
					messageElement.className = 'error-message';
					messageElement.textContent = '사용자 정보를 불러오는 데 실패했습니다.';
				}
			} catch (error) {
				console.error('Error fetching user info for edit:', error);
				messageElement.className = 'error-message';
				messageElement.textContent = '네트워크 오류로 사용자 정보를 불러올 수 없습니다.';
			}

			// 2. 폼 제출 시 정보 업데이트 API 호출
			editProfileForm.addEventListener('submit', async function (event) {
				event.preventDefault();

				const name = nameInput.value.trim();
				const newPassword = passwordInput.value.trim();
				const confirmPassword = confirmPasswordInput.value.trim();

				if (newPassword && newPassword !== confirmPassword) { // 새 비밀번호가 있고 일치하지 않으면
					messageElement.className = 'error-message';
					messageElement.textContent = '새 비밀번호와 비밀번호 확인이 일치하지 않습니다.';
					return;
				}
				// 새 비밀번호가 입력되었는데 확인 필드가 비어있을 경우 (또는 그 반대)
				if ((newPassword && !confirmPassword) || (!newPassword && confirmPassword)) {
					messageElement.className = 'error-message';
					messageElement.textContent = '새 비밀번호를 입력하려면 확인 필드도 채워주세요.';
					return;
				}


				// 업데이트할 데이터 객체 생성
				const updateData = {
					name: name
				};
				if (newPassword) { // 비밀번호 필드가 비어있지 않으면 업데이트 데이터에 포함
					updateData.password = newPassword;
				}

				try {
					const response = await fetch('/api/auth/update', {
						method: 'PUT', // PUT 요청
						headers: {
							'Content-Type': 'application/json'
						},
						body: JSON.stringify(updateData)
					});

					if (response.ok) {
						messageElement.className = 'success-message';
						messageElement.textContent = '정보가 성공적으로 업데이트되었습니다!';
						passwordInput.value = ''; // 비밀번호 필드 초기화
						confirmPasswordInput.value = ''; // 비밀번호 확인 필드 초기화
						window.location.href = '/home'; // /home으로 리다이렉트
					} else if (response.status === 400) {
						const errorData = await response.json(); // JSON으로 파싱
						messageElement.className = 'error-message';
						// errorData.message가 존재하면 그 값을 사용, 없으면 기본 메시지
						messageElement.textContent = errorData.message || '잘못된 요청입니다. 다시 확인해주세요.';
					} else if (response.status === 401) {
						messageElement.className = 'error-message';
						messageElement.textContent = '세션이 만료되었거나 인증되지 않았습니다. 로그인 페이지로 이동합니다.';
						setTimeout(() => {window.location.href = '/login';}, 1500);
					}
					else {
						messageElement.className = 'error-message';
						messageElement.textContent = '정보 업데이트 중 오류가 발생했습니다. 다시 시도해주세요.';
					}
				} catch (error) {
					console.error('Error updating profile:', error);
					messageElement.className = 'error-message';
					messageElement.textContent = '네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.';
				}
			});
		});
	</script>
</body>

</html>